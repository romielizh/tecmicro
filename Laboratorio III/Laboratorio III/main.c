/*
 * main.c
 *
 * Created: 11/7/2023 11:03:38 AM
 *  Author: romin
 */ 
//?????????????????????????????????????????????????????????????????????????????????????????//

#include <avr/io.h>
#include <util/delay.h>

//?????????????????????????????????????????????????????????????????????????????????????????//

// Pines conectados al puente HX
#define XIN1 PINB0
#define XIN2 PINB1
#define XIN3 PINB2
#define XIN4 PINB3

// Pines conectados al puente HY
#define YIN1 PIND2
#define YIN2 PIND3
#define YIN3 PIND4
#define YIN4 PIND5

//?????????????????????????????????????????????????????????????????????????????????????????//

void setStepX(int step)
{
	// Tabla de pasos
	int sequence[4][4] =
	{
		{1, 0, 1, 0},
		{0, 1, 1, 0}, //ésta tabla funciona
		{0, 1, 0, 1},
		{1, 0, 0, 1}
	};

	// Configura los pines del puente HX según la tabla
	for (int i = 0; i < 4; i++)
	{
		if (sequence[step][i])
		{
			// Configura el pin en alto
			switch (i)
			{
				case 0:
				PORTB |= (1 << XIN1);
				break;
				case 1:
				PORTB |= (1 << XIN2);
				break;
				case 2:
				PORTB |= (1 << XIN3);
				break;
				case 3:
				PORTB |= (1 << XIN4);
				break;
			}
		}
		else
		{
			// Configura el pin en bajo
			switch (i)
			{
				case 0:
				PORTB &= ~(1 << XIN1);
				break;
				case 1:
				PORTB &= ~(1 << XIN2);
				break;
				case 2:
				PORTB &= ~(1 << XIN3);
				break;
				case 3:
				PORTB &= ~(1 << XIN4);
				break;
			}
		}
	}
}

//?????????????????????????????????????????????????????????????????????????????????????????//

void setStepY(int step)
{
	// Tabla de pasos
	int sequence[4][4] =
	{
		{1, 0, 1, 0},
		{0, 1, 1, 0}, //ésta tabla funciona
		{0, 1, 0, 1},
		{1, 0, 0, 1}
	};

	// Configura los pines del puente HY según la tabla
	for (int i = 0; i < 4; i++)
	{
		if (sequence[step][i])
		{
			// Configura el pin en alto
			switch (i)
			{
				case 0:
				PORTD |= (1 << YIN1);
				break;
				case 1:
				PORTD |= (1 << YIN2);
				break;
				case 2:
				PORTD |= (1 << YIN3);
				break;
				case 3:
				PORTD |= (1 << YIN4);
				break;
			}
		}
		else
		{
			// Configura el pin en bajo
			switch (i)
			{
				case 0:
				PORTD &= ~(1 << YIN1);
				break;
				case 1:
				PORTD &= ~(1 << YIN2);
				break;
				case 2:
				PORTD &= ~(1 << YIN3);
				break;
				case 3:
				PORTD &= ~(1 << YIN4);
				break;
			}
		}
	}
}

//?????????????????????????????????????????????????????????????????????????????????????????//

int main(void)
{
	// Configura los pines de control del puente HX como salidas
	DDRB |= (1 << XIN1) | (1 << XIN2) | (1 << XIN3) | (1 << XIN4);
	
	// Configura los pines de control del puente HY como salidas
	DDRD |= (1 << YIN1) | (1 << YIN2) | (1 << YIN3) | (1 << YIN4);

	while (1)
	{
		// Gira el motor en una dirección
		for (int i = 0; i < 4; i++)
		{
			setStepX(i);
			setStepY(i);
			_delay_ms(100);										// Ajuste de tiempo entre pasos según la velocidad deseada
		}
	}

	return 0;
}
//?????????????????????????????????????????????????????????????????????????????????????????//